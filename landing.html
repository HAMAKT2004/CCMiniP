<!DOCTYPE html>
<html>
<head>
    <title>Welcome</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 600;
            color: var(--primary-color);
            animation: slideInLeft 0.5s ease-out;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .logout-btn {
            padding: 10px 20px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .logout-btn:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .info-section {
            margin: 30px 0;
            padding: 20px;
            background: var(--container-bg);
            border-radius: 10px;
            animation: fadeIn 0.5s ease-out 0.2s backwards;
        }

        .info-section h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .info-item {
            margin: 15px 0;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: transform 0.3s ease;
            color: var(--text-color);
        }

        .info-item:hover {
            transform: translateX(5px);
        }

        .login-history {
            margin-top: 30px;
            animation: fadeIn 0.5s ease-out 0.4s backwards;
        }

        .login-history h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .login-history table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            background: var(--container-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .login-history th {
            background-color: var(--table-header-bg);
            color: var(--table-header-color);
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }

        .login-history td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .login-history tr:last-child td {
            border-bottom: none;
        }

        .login-history tr:hover {
            background-color: var(--table-row-hover);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-active {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }

        .status-inactive {
            background-color: rgba(158, 158, 158, 0.1);
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                margin-bottom: 15px;
            }

            .login-history table {
                display: block;
                overflow-x: auto;
            }
        }

        /* Tabs Styling */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 12px 24px;
            background: var(--input-bg);
            border: none;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: var(--primary-color);
            color: white;
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Weather Section */
        .weather-section {
            padding: 20px;
            background: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .search-bar button {
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .search-bar button:hover {
            background: #357abd;
            transform: translateY(-2px);
        }

        .weather-history {
            margin-top: 30px;
            background: var(--container-bg);
            border-radius: 10px;
            overflow: hidden;
        }

        .weather-history h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .weather-history-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .weather-history-table th {
            background-color: var(--table-header-bg);
            color: var(--table-header-color);
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }

        .weather-history-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .weather-history-table tr:last-child td {
            border-bottom: none;
        }

        .weather-history-table tr:hover {
            background-color: var(--table-row-hover);
        }

        .weather-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .weather-card {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .weather-card:hover {
            transform: translateY(-5px);
        }

        .weather-card i {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .weather-card h4 {
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .weather-card p {
            color: var(--text-color);
            font-size: 1.2em;
            font-weight: 500;
        }

        .weather-details-section {
            padding: 20px;
            background: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .detail-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .detail-card {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .detail-card h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: var(--container-bg);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: transform 0.2s ease;
        }

        .detail-item:hover {
            transform: translateY(-2px);
        }

        .detail-item .label {
            color: var(--text-color);
            font-size: 0.9em;
            opacity: 0.8;
            font-weight: 500;
        }

        .detail-item .value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.1em;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .forecast-day {
            text-align: center;
            padding: 15px;
            background: var(--container-bg);
            border-radius: 8px;
            transition: transform 0.2s ease;
        }

        .forecast-day:hover {
            transform: translateY(-2px);
        }

        .forecast-day .date {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .forecast-day img {
            width: 64px;
            height: 64px;
            margin: 10px 0;
        }

        .forecast-day .temp-range {
            font-weight: 600;
            margin: 10px 0;
        }

        .forecast-day .condition {
            color: var(--text-color);
            margin: 5px 0;
        }

        .forecast-day .rain-chance {
            color: var(--primary-color);
            font-weight: 500;
        }

        .hourly-scroll {
            overflow-x: auto;
            display: flex;
            gap: 15px;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--container-bg);
        }

        .hourly-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .hourly-scroll::-webkit-scrollbar-track {
            background: var(--container-bg);
            border-radius: 4px;
        }

        .hourly-scroll::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .hourly-item {
            min-width: 120px;
            text-align: center;
            padding: 15px;
            background: var(--container-bg);
            border-radius: 8px;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }

        .hourly-item:hover {
            transform: translateY(-2px);
        }

        .hourly-item .time {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .hourly-item img {
            width: 48px;
            height: 48px;
            margin: 8px 0;
        }

        .hourly-item .temp {
            font-weight: 600;
            margin: 8px 0;
        }

        .hourly-item .rain-chance {
            color: var(--primary-color);
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .detail-cards {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .forecast-grid {
                grid-template-columns: 1fr;
            }
        }

        /* About section styles */
        .about-section {
            padding: 20px;
            background: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .developer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .developers, .project-details {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .developers h4, .project-details h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }

        .developer-list {
            list-style: none;
            padding: 0;
        }

        .developer-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            font-weight: 500;
        }

        .developer-list li:last-child {
            border-bottom: none;
        }

        .project-details p {
            margin-bottom: 15px;
            color: var(--text-color);
            line-height: 1.6;
        }

        .project-details ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .project-details ul li {
            margin-bottom: 8px;
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .developer-info {
                grid-template-columns: 1fr;
            }
        }

        /* Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .chatbot-button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .chatbot-popup {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chatbot-header {
            padding: 15px;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-chatbot {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .chatbot-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            animation: fadeIn 0.3s ease;
        }

        .user-message {
            background: var(--primary-gradient);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chatbot-input {
            padding: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
        }

        .chatbot-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .chatbot-input button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chatbot-input button:hover {
            transform: scale(1.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dark theme adjustments */
        [data-theme="dark"] .chatbot-popup {
            background: var(--dark-card-bg);
        }

        [data-theme="dark"] .bot-message {
            background: rgba(255, 255, 255, 0.1);
            color: var(--dark-text);
        }

        [data-theme="dark"] .chatbot-input input {
            background: rgba(255, 255, 255, 0.05);
            color: var(--dark-text);
            border-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </button>

    <div class="container">
        <div class="header">
            <h1>Welcome, <span id="username"></span>!</h1>
            <a href="process_logout.php" class="logout-btn">Logout</a>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab('weather')">
                <i class="fas fa-cloud-sun"></i> Weather
            </button>
            <button class="tab-button" onclick="openTab('weather-details')">
                <i class="fas fa-chart-bar"></i> Detailed Weather
            </button>
            <button class="tab-button" onclick="openTab('login-history')">
                <i class="fas fa-history"></i> Login History
            </button>
            <button class="tab-button" onclick="openTab('about')">
                <i class="fas fa-info-circle"></i> About
            </button>
        </div>

        <div id="weather" class="tab-content active">
            <div class="weather-section">
                <h3>Current Weather</h3>
                <div class="search-bar">
                    <input type="text" id="city-search" placeholder="Enter city name..." />
                    <button onclick="searchWeather()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div class="weather-info">
                    <div class="weather-card">
                        <i class="fas fa-map-marker-alt"></i>
                        <h4>Location</h4>
                        <p id="location">Loading...</p>
                    </div>
                    <div class="weather-card">
                        <i class="fas fa-temperature-high"></i>
                        <h4>Temperature</h4>
                        <p id="temperature">Loading...</p>
                    </div>
                    <div class="weather-card">
                        <i class="fas fa-tint"></i>
                        <h4>Humidity</h4>
                        <p id="humidity">Loading...</p>
                    </div>
                    <div class="weather-card">
                        <i class="fas fa-wind"></i>
                        <h4>Wind Speed</h4>
                        <p id="wind-speed">Loading...</p>
                    </div>
                    <div class="weather-card">
                        <i class="fas fa-cloud"></i>
                        <h4>Conditions</h4>
                        <p id="conditions">Loading...</p>
                    </div>
                </div>

                <div class="weather-history">
                    <h3>Search History</h3>
                    <table class="weather-history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Location</th>
                                <th>Temperature</th>
                                <th>Conditions</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="weather-history-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="weather-details" class="tab-content">
            <div class="weather-details-section">
                <h3>Detailed Weather Information</h3>
                <div class="detail-cards">
                    <div class="detail-card current-conditions">
                        <h4><i class="fas fa-thermometer-half"></i> Current Conditions</h4>
                        <div class="detail-grid" id="current-conditions">
                            <div class="detail-item">
                                <span class="label">Last Updated</span>
                                <span class="value" id="detail-last-updated">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Temperature</span>
                                <span class="value" id="detail-temp">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Feels Like</span>
                                <span class="value" id="detail-feels-like">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Wind</span>
                                <span class="value" id="detail-wind">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Pressure</span>
                                <span class="value" id="detail-pressure">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Precipitation</span>
                                <span class="value" id="detail-precip">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Humidity</span>
                                <span class="value" id="detail-humidity">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Cloud Cover</span>
                                <span class="value" id="detail-cloud">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Visibility</span>
                                <span class="value" id="detail-visibility">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">UV Index</span>
                                <span class="value" id="detail-uv">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Wind Chill</span>
                                <span class="value" id="detail-wind-chill">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Heat Index</span>
                                <span class="value" id="detail-heat-index">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Dew Point</span>
                                <span class="value" id="detail-dew-point">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-card forecast">
                        <h4><i class="fas fa-calendar-alt"></i> 3-Day Forecast</h4>
                        <div class="forecast-grid" id="forecast-grid">
                            <!-- Forecast data will be inserted here -->
                        </div>
                    </div>

                    <div class="detail-card astronomy">
                        <h4><i class="fas fa-moon"></i> Astronomy</h4>
                        <div class="detail-grid" id="astronomy-info">
                            <!-- Astronomy data will be inserted here -->
                        </div>
                    </div>

                    <div class="detail-card hourly">
                        <h4><i class="fas fa-clock"></i> Hourly Forecast</h4>
                        <div class="hourly-scroll" id="hourly-forecast">
                            <!-- Hourly forecast data will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="login-history" class="tab-content">
            <div class="info-section">
                <h3>Account Information</h3>
                <div class="info-item">
                    <strong>Account Created:</strong> <span id="created-at"></span>
                </div>
                <div class="info-item">
                    <strong>Current Login Time:</strong> <span id="login-time"></span>
                </div>
            </div>

            <div class="login-history">
                <h3>Login History</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Login Time</th>
                            <th>Logout Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="login-history-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="about" class="tab-content">
            <div class="about-section">
                <h3>About This Project</h3>
                <div class="developer-info">
                    <div class="developers">
                        <h4><i class="fas fa-users"></i> Developers</h4>
                        <ul class="developer-list">
                            <li>Harsh Amrute</li>
                            <li>Ayush Bhosale</li>
                            <li>Peter Bose</li>
                            <li>Bryson D'Souza</li>
                        </ul>
                    </div>
                    <div class="project-details">
                        <h4><i class="fas fa-project-diagram"></i> Project Information</h4>
                        <p>This weather tracking system features user authentication, detailed weather information, and personalized history tracking.</p>
                        <p>The application includes:</p>
                        <ul>
                            <li>Secure login/signup system</li>
                            <li>Real-time weather data</li>
                            <li>3-day forecast and hourly predictions</li>
                            <li>Astronomy information</li>
                            <li>User-specific weather search history</li>
                            <li>Dark/light theme support</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot UI -->
    <div class="chatbot-container">
        <button class="chatbot-button" onclick="toggleChatbot()">
            <i class="fas fa-robot"></i>
        </button>
        <div class="chatbot-popup" id="chatbotPopup">
            <div class="chatbot-header">
                <h3>Weather AI Assistant</h3>
                <button class="close-chatbot" onclick="toggleChatbot()">×</button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="message bot-message">
                    Hello! I'm your weather AI assistant. How can I help you today?
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" placeholder="Ask me anything about weather..." onkeypress="handleChatbotInput(event)">
                <button onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        function openTab(tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            const tabButtons = document.getElementsByClassName('tab-button');
            
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
                tabButtons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Weather API functionality
        const API_KEY = 'f878330c730d40abafd183919250704';
        let weatherHistory = [];

        async function loadWeatherHistory() {
            try {
                const response = await fetch('get_weather_history.php');
                const data = await response.json();
                if (data.status === 'success') {
                    weatherHistory = data.weather_history.map(item => ({
                        timestamp: item.timestamp,
                        location: `${item.location.name}, ${item.location.country}`,
                        temperature: `${item.current.temp_c}°C`,
                        conditions: item.current.condition.text
                    }));
                    updateWeatherHistory();
                }
            } catch (error) {
                console.error('Error loading weather history:', error);
            }
        }

        async function searchWeather() {
            const cityInput = document.getElementById('city-search');
            const city = cityInput.value.trim();
            
            if (!city) {
                alert('Please enter a city name');
                return;
            }

            try {
                await getWeather(city);
                cityInput.value = '';
                // Reload weather history after new search
                await loadWeatherHistory();
            } catch (error) {
                console.error('Error searching weather:', error);
            }
        }

        // Add event listener for Enter key
        document.getElementById('city-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchWeather();
            }
        });

        async function getWeather(city = 'auto:ip') {
            try {
                // Fetch current weather, forecast, and marine data
                const [currentResponse, forecastResponse] = await Promise.all([
                    fetch(`https://api.weatherapi.com/v1/current.json?key=${API_KEY}&q=${city}&aqi=no`),
                    fetch(`https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${city}&days=3&aqi=no&alerts=no&tide=yes`)
                ]);

                const currentData = await currentResponse.json();
                const forecastData = await forecastResponse.json();
                
                if (currentData.error || forecastData.error) {
                    throw new Error(currentData.error?.message || forecastData.error?.message);
                }

                const weatherData = {
                    timestamp: new Date().toISOString(),
                    username: document.getElementById('username').textContent,
                    location: {
                        name: currentData.location.name,
                        country: currentData.location.country,
                        lat: currentData.location.lat,
                        lon: currentData.location.lon,
                        localtime: currentData.location.localtime
                    },
                    current: {
                        last_updated_epoch: currentData.current.last_updated_epoch,
                        last_updated: currentData.current.last_updated,
                        temp_c: currentData.current.temp_c,
                        temp_f: currentData.current.temp_f,
                        is_day: currentData.current.is_day,
                        condition: {
                            text: currentData.current.condition.text,
                            icon: currentData.current.condition.icon,
                            code: currentData.current.condition.code
                        },
                        wind_mph: currentData.current.wind_mph,
                        wind_kph: currentData.current.wind_kph,
                        wind_degree: currentData.current.wind_degree,
                        wind_dir: currentData.current.wind_dir,
                        pressure_mb: currentData.current.pressure_mb,
                        pressure_in: currentData.current.pressure_in,
                        precip_mm: currentData.current.precip_mm,
                        precip_in: currentData.current.precip_in,
                        humidity: currentData.current.humidity,
                        cloud: currentData.current.cloud,
                        feelslike_c: currentData.current.feelslike_c,
                        feelslike_f: currentData.current.feelslike_f,
                        vis_km: currentData.current.vis_km,
                        vis_miles: currentData.current.vis_miles,
                        uv: currentData.current.uv,
                        gust_mph: currentData.current.gust_mph,
                        gust_kph: currentData.current.gust_kph,
                        windchill_c: currentData.current.windchill_c,
                        windchill_f: currentData.current.windchill_f,
                        heatindex_c: currentData.current.heatindex_c,
                        heatindex_f: currentData.current.heatindex_f,
                        dewpoint_c: currentData.current.dewpoint_c,
                        dewpoint_f: currentData.current.dewpoint_f
                    },
                    forecast: forecastData.forecast.forecastday.map(day => ({
                        date: day.date,
                        date_epoch: day.date_epoch,
                        day: {
                            maxtemp_c: day.day.maxtemp_c,
                            maxtemp_f: day.day.maxtemp_f,
                            mintemp_c: day.day.mintemp_c,
                            mintemp_f: day.day.mintemp_f,
                            avgtemp_c: day.day.avgtemp_c,
                            avgtemp_f: day.day.avgtemp_f,
                            maxwind_mph: day.day.maxwind_mph,
                            maxwind_kph: day.day.maxwind_kph,
                            totalprecip_mm: day.day.totalprecip_mm,
                            totalprecip_in: day.day.totalprecip_in,
                            avgvis_km: day.day.avgvis_km,
                            avgvis_miles: day.day.avgvis_miles,
                            avghumidity: day.day.avghumidity,
                            condition: {
                                text: day.day.condition.text,
                                icon: day.day.condition.icon,
                                code: day.day.condition.code
                            },
                            daily_will_it_rain: day.day.daily_will_it_rain,
                            daily_will_it_snow: day.day.daily_will_it_snow,
                            daily_chance_of_rain: day.day.daily_chance_of_rain,
                            daily_chance_of_snow: day.day.daily_chance_of_snow,
                            uv: day.day.uv,
                            totalsnow_cm: day.day.totalsnow_cm
                        },
                        astro: {
                            sunrise: day.astro.sunrise,
                            sunset: day.astro.sunset,
                            moonrise: day.astro.moonrise,
                            moonset: day.astro.moonset,
                            moon_phase: day.astro.moon_phase,
                            moon_illumination: day.astro.moon_illumination,
                            is_sun_up: day.astro.is_sun_up,
                            is_moon_up: day.astro.is_moon_up
                        },
                        hour: day.hour.map(h => ({
                            time_epoch: h.time_epoch,
                            time: h.time,
                            temp_c: h.temp_c,
                            temp_f: h.temp_f,
                            is_day: h.is_day,
                            condition: {
                                text: h.condition.text,
                                icon: h.condition.icon,
                                code: h.condition.code
                            },
                            wind_mph: h.wind_mph,
                            wind_kph: h.wind_kph,
                            wind_degree: h.wind_degree,
                            wind_dir: h.wind_dir,
                            pressure_mb: h.pressure_mb,
                            pressure_in: h.pressure_in,
                            precip_mm: h.precip_mm,
                            precip_in: h.precip_in,
                            snow_cm: h.snow_cm,
                            humidity: h.humidity,
                            cloud: h.cloud,
                            feelslike_c: h.feelslike_c,
                            feelslike_f: h.feelslike_f,
                            windchill_c: h.windchill_c,
                            windchill_f: h.windchill_f,
                            heatindex_c: h.heatindex_c,
                            heatindex_f: h.heatindex_f,
                            dewpoint_c: h.dewpoint_c,
                            dewpoint_f: h.dewpoint_f,
                            will_it_rain: h.will_it_rain,
                            will_it_snow: h.will_it_snow,
                            vis_km: h.vis_km,
                            vis_miles: h.vis_miles,
                            chance_of_rain: h.chance_of_rain,
                            chance_of_snow: h.chance_of_snow,
                            gust_mph: h.gust_mph,
                            gust_kph: h.gust_kph,
                            uv: h.uv
                        }))
                    }))
                };

                // Save weather data to database
                await saveWeatherData(weatherData);

                // Update current weather display
                document.getElementById('location').textContent = `${weatherData.location.name}, ${weatherData.location.country}`;
                document.getElementById('temperature').textContent = `${weatherData.current.temp_c}°C`;
                document.getElementById('humidity').textContent = `${weatherData.current.humidity}%`;
                document.getElementById('wind-speed').textContent = `${weatherData.current.wind_kph} km/h`;
                document.getElementById('conditions').textContent = weatherData.current.condition.text;

                // Add to history if it's a search (not auto:ip)
                if (city !== 'auto:ip') {
                    weatherHistory.unshift({
                        timestamp: weatherData.timestamp,
                        location: `${weatherData.location.name}, ${weatherData.location.country}`,
                        temperature: `${weatherData.current.temp_c}°C`,
                        conditions: weatherData.current.condition.text
                    });
                    // Keep only last 10 searches
                    weatherHistory = weatherHistory.slice(0, 10);
                    localStorage.setItem('weatherHistory', JSON.stringify(weatherHistory));
                    updateWeatherHistory();
                }

                // Update detailed weather view
                updateDetailedWeather(weatherData);
            } catch (error) {
                console.error('Error fetching weather:', error);
                alert('Error: ' + (error.message || 'Failed to fetch weather data'));
            }
        }

        async function saveWeatherData(weatherData) {
            try {
                const response = await fetch('save_weather.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(weatherData)
                });

                if (!response.ok) {
                    throw new Error('Failed to save weather data');
                }
            } catch (error) {
                console.error('Error saving weather data:', error);
            }
        }

        function updateWeatherHistory() {
            const tbody = document.getElementById('weather-history-body');
            tbody.innerHTML = '';

            weatherHistory.forEach((item, index) => {
                const row = document.createElement('tr');
                const time = new Date(item.timestamp).toLocaleString();
                
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${item.location}</td>
                    <td>${item.temperature}</td>
                    <td>${item.conditions}</td>
                    <td>
                        <button onclick="reloadWeather(${index})" class="tab-button" style="padding: 5px 10px;">
                            <i class="fas fa-redo"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function reloadWeather(index) {
            const item = weatherHistory[index];
            const city = item.location.split(',')[0];
            getWeather(city);
        }

        // Existing functionality
        document.getElementById('username').textContent = '{{username}}';
        document.getElementById('created-at').textContent = '{{created_at}}';
        document.getElementById('login-time').textContent = '{{login_time}}';
        
        // Populate login history
        const loginHistory = JSON.parse('{{login_history}}');
        const tbody = document.getElementById('login-history-body');
        
        loginHistory.forEach(entry => {
            const row = document.createElement('tr');
            row.style.animation = 'fadeIn 0.5s ease-out';
            
            const loginCell = document.createElement('td');
            loginCell.textContent = entry.login_time;
            row.appendChild(loginCell);
            
            const logoutCell = document.createElement('td');
            logoutCell.textContent = entry.logout_time || 'Still logged in';
            row.appendChild(logoutCell);
            
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = 'status-badge ' + (entry.logout_time ? 'status-inactive' : 'status-active');
            statusBadge.textContent = entry.logout_time ? 'Completed' : 'Active';
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);
            
            tbody.appendChild(row);
        });

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle i');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.classList.remove('fa-sun');
                themeToggle.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.classList.remove('fa-moon');
                themeToggle.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeToggle.classList.remove('fa-moon');
                themeToggle.classList.add('fa-sun');
            }

            // Get weather data and load history from database
            getWeather();
            loadWeatherHistory();
        });

        function updateDetailedWeather(weatherData) {
            // Update current conditions
            document.getElementById('detail-last-updated').textContent = weatherData.current.last_updated;
            document.getElementById('detail-temp').textContent = `${weatherData.current.temp_c}°C / ${weatherData.current.temp_f}°F`;
            document.getElementById('detail-feels-like').textContent = `${weatherData.current.feelslike_c}°C / ${weatherData.current.feelslike_f}°F`;
            document.getElementById('detail-wind').textContent = `${weatherData.current.wind_kph} km/h ${weatherData.current.wind_dir}`;
            document.getElementById('detail-pressure').textContent = `${weatherData.current.pressure_mb} mb`;
            document.getElementById('detail-precip').textContent = `${weatherData.current.precip_mm} mm`;
            document.getElementById('detail-humidity').textContent = `${weatherData.current.humidity}%`;
            document.getElementById('detail-cloud').textContent = `${weatherData.current.cloud}%`;
            document.getElementById('detail-visibility').textContent = `${weatherData.current.vis_km} km`;
            document.getElementById('detail-uv').textContent = weatherData.current.uv;
            document.getElementById('detail-wind-chill').textContent = `${weatherData.current.windchill_c}°C`;
            document.getElementById('detail-heat-index').textContent = `${weatherData.current.heatindex_c}°C`;
            document.getElementById('detail-dew-point').textContent = `${weatherData.current.dewpoint_c}°C`;

            // Update forecast
            const forecastGrid = document.getElementById('forecast-grid');
            forecastGrid.innerHTML = weatherData.forecast.map(day => `
                <div class="forecast-day">
                    <div class="date">${new Date(day.date).toLocaleDateString()}</div>
                    <img src="https:${day.day.condition.icon}" alt="${day.day.condition.text}">
                    <div class="temp-range">${day.day.mintemp_c}°C - ${day.day.maxtemp_c}°C</div>
                    <div class="condition">${day.day.condition.text}</div>
                    <div class="rain-chance">Rain: ${day.day.daily_chance_of_rain}%</div>
                </div>
            `).join('');

            // Update astronomy
            const astronomyInfo = document.getElementById('astronomy-info');
            const todayAstro = weatherData.forecast[0].astro;
            astronomyInfo.innerHTML = `
                <div class="detail-item">
                    <span class="label">Sunrise:</span>
                    <span class="value">${todayAstro.sunrise}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Sunset:</span>
                    <span class="value">${todayAstro.sunset}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Moonrise:</span>
                    <span class="value">${todayAstro.moonrise}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Moonset:</span>
                    <span class="value">${todayAstro.moonset}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Moon Phase:</span>
                    <span class="value">${todayAstro.moon_phase}</span>
                </div>
                <div class="detail-item">
                    <span class="label">Moon Illumination:</span>
                    <span class="value">${todayAstro.moon_illumination}%</span>
                </div>
            `;

            // Update hourly forecast
            const hourlyForecast = document.getElementById('hourly-forecast');
            hourlyForecast.innerHTML = weatherData.forecast[0].hour.map(hour => `
                <div class="hourly-item">
                    <div class="time">${hour.time.split(' ')[1]}</div>
                    <img src="https:${hour.condition.icon}" alt="${hour.condition.text}">
                    <div class="temp">${hour.temp_c}°C</div>
                    <div class="rain-chance">Rain: ${hour.chance_of_rain}%</div>
                </div>
            `).join('');
        }
        // Chatbot functionality
const GEMINI_API_KEY = 'AIzaSyBAIUB5w8Bn9llRVCq9NKgyXsej0KQUtbQ'; // Consider securing this server-side
let currentWeatherData = null;

function toggleChatbot() {
    const popup = document.getElementById('chatbotPopup');
    popup.style.display = popup.style.display === 'flex' ? 'none' : 'flex';
}

function addMessage(message, isUser = false) {
    const messagesContainer = document.getElementById('chatbotMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
    messageDiv.textContent = message;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return messageDiv;
}

async function getGeminiResponse(prompt) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                signal: controller.signal,
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: ` ${
                                currentWeatherData ? JSON.stringify(currentWeatherData) : ''
                            }. User question: ${prompt}. Provide a concise and helpful response, using weather data if relevant.`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                    ]
                })
            }
        );

        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
        }

        const data = await response.json();

        if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
            throw new Error('Unexpected response format from Gemini API');
        }

        return data.candidates[0].content.parts[0].text;
    } catch (error) {
        console.error('Gemini API Error:', error);
        if (error.name === 'AbortError') {
            return "Request timed out. Please try again.";
        }
        return `Sorry, I couldn’t process your request: ${error.message}. Try again later.`;
    }
}

async function sendMessage() {
    const input = document.getElementById('chatbotInput');
    const message = input.value.trim();

    if (!message) return;

    addMessage(message, true);
    input.value = '';

    const loadingMessage = addMessage("Thinking...", false);

    try {
        const response = await getGeminiResponse(message);
        loadingMessage.remove();
        addMessage(response);
    } catch (error) {
        loadingMessage.remove();
        addMessage("Sorry, I’m having trouble processing your request. Please try again.");
    }
}

function handleChatbotInput(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Ensure currentWeatherData is updated when weather is fetched
const originalGetWeather = getWeather;
getWeather = async function(location) {
    const result = await originalGetWeather(location);
    if (result) {
        currentWeatherData = result; // Update global weather data
        console.log('Weather data updated:', currentWeatherData); // Debug log
    }
    return result;
};
        
    </script>
</body>
</html>